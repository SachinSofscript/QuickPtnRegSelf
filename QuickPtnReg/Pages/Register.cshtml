@page
@model RegisterModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "SELF REGISTRATION";
}

@section scripts {
    <script>

        function disableSubmitButton() {
            var submitButton = document.getElementById("submitButton");
            submitButton.disabled = true; // Disable the button
            // Optionally, display a loading indicator
        }

        function validateDownload() {

            var departmentCode = $('#patientsource2').val();
            if (!departmentCode > 0) {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Select patient source!",
                });
                return true;
            }
            else {

                return false;
            }
        }


        $(document).ready(function () {
            $('#fullName').focus(); // Set focus to Full Name textbox

            $('#btnDownload').click(function () {

                var selectedValue = document.getElementById("patientsource2").value;
                if (!selectedValue) {
                    //  alert("Please select a patient source ");
                    return false;
                }
                else {

                    downloadData();

                }


            });
        });

        function downloadData() {


            // Method to save data
            var departmentCode = $('#patientsource2').val();

            console.log('downloadData called...');

            // Perform AJAX request to save data
            // Example AJAX request using jQuery:
            $.ajax({
                url: "/Register?handler=DownloadData", // Change the URL to match your controller and action method
                type: 'POST',
                // method: 'OnPostDownloadData',
                data: { departmentCode: departmentCode },
                success: function (response) {
                    // Handle success
                    console.log(response);
                },
                error: function (xhr, status, error) {
                    // Handle error
                    console.error(xhr.responseText);
                }
            });
        }


        $(function () {
            $('#clearForm').click(function () {
                $('form').trigger('reset');
                $('#fullName').focus();
            });

        });

        $(function () {

            // $('#btnSubmit').click(function (e) {
            $('#regForm').submit(function (e) {
                //debugger;
                e.preventDefault();

                var form = $(this);
                if (!form.valid()) {
                return false; // Stop AJAX if client-side validation fails
                }



                // Disable the submit button
                $("#btnSubmit").prop("disabled", true);

                //------------------------------------------

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function (response) {
                        // Extract department description from selected option
                        //var departmentDescription = $('#department option:selected').text();

                        Swal.fire({
                            icon: 'success',
                            title: response.message,
                            //text: 'Patient No: ' + response.patientNo
                            html: 'Patient No: ' + response.patientNo + '<br>' +
                                 'Patient Name: ' + response.patientFullName 
                                // 'Department Description: ' + departmentDescription
                        }).then((result) => {
                            if (result.value) {
                                //  window.location.href = '/Register'; // Redirect to index page
                                $('form').trigger('reset'); // Clear the form
                                $('#fullName').focus(); // Set focus to Full Name textbox

                            }
                        })

                    },
                    error: function (xhr, status, error) {

                    },
                    complete: function () {
                        // Re-enable the submit button
                        $("#btnSubmit").prop("disabled", false);
                    }

                });
                //--------------------------------------
            });
        });

    </script>

    <script>
        // document.addEventListener('DOMContentLoaded', function () {
        //     const deptSelect = document.getElementById('department');
        //     const unitSelect = document.getElementById('departmentUnit');

        //     if (!deptSelect || !unitSelect) return;

        //     deptSelect.addEventListener('change', async function () {
        //         const spltycd = this.value;
        //         // Clear existing options
        //         unitSelect.innerHTML = '<option value="">Select Unit</option>';

        //         if (!spltycd) return;

        //         try {
        //             // call current page handler: ?handler=DepartmentUnits&spltycd=xyz
        //             const url = `${window.location.pathname}?handler=DepartmentUnits&spltycd=${encodeURIComponent(spltycd)}`;
        //             const resp = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' }});
        //             if (!resp.ok) throw new Error('Network response was not ok');

        //             const units = await resp.json(); // units expected: [{ UnitCd: 1, UnitName: '...' }, ...]
        //             if (Array.isArray(units)) {
        //                 units.forEach(u => {
        //                     const opt = document.createElement('option');
        //                     opt.value = u.unitCd ?? u.UnitCd ?? '';
        //                     opt.text = u.unitName ?? u.UnitName ?? '';
        //                     unitSelect.appendChild(opt);
        //                 });
        //             }
        //         } catch (err) {
        //             console.error('Failed to load department units:', err);
        //             // optionally show user-friendly message
        //         }
        //     });
        // });
    </script>




}






@if (!ModelState.IsValid)
{
    <div class="alert alert-danger" role="alert">
        <ul>
            @foreach (var modelError in ViewData.ModelState.Values.SelectMany(m => m.Errors))
            {
                <li>@modelError.ErrorMessage</li>
            }
        </ul>
    </div>
}

<br />

<form  method="post" id="regForm">

    @Html.AntiForgeryToken()

    <div class="card">
        <div class="card-header">
            Register a Patient
        </div>
        <div class="card-body">
            <div class="form-group">
                <span class="text-danger">*</span>
                <label for="fullName">Full Name / ಪೂರ್ಣ ಹೆಸರು (ಆಧಾರ್ ಕಾರ್ಡ್ ನಲ್ಲಿರುವಂತೆ):</label>
                <input type="text" id="fullName" class="form-control" asp-for="Patient.PatientFullName"  />
                <span asp-validation-for="Patient.PatientFullName" class="text-danger small" >  </span>


                <small id="emailHelp" class="form-text text-muted">Enter patient's full name.'</small>
            </div>

            <br />

            <div class="form-group">
                <label for="fatherName">Father's name / ತಂದೆಯ ಹೆಸರು:</label>
                <input type="text" id="fatherName" class="form-control" asp-for="Patient.PatientMiddleName" />
            </div>

            <br />
            <div class="form-group">
                <span class="text-danger">*</span>
                <label for="age">Age / ವಯಸ್ಸು:</label>
                <input type="number" id="age" class="form-control" asp-for="Patient.Age" />
                <span asp-validation-for="Patient.Age" class="text-danger small"></span>

                <small id="emailHelp" class="form-text text-muted">Enter patient's age in years.</small>
            </div>

            <br />


            <div class="form-group">
                <span class="text-danger">*</span>
                <label for="sex">Sex / ಲಿಂಗ:</label><br />
                <input type="radio" id="male" name="Patient.sex" value="M" asp-for="Patient.sex" /> Male
                <input type="radio" id="female" name="Patient.sex" value="F" asp-for="Patient.sex" /> Female
                <input type="radio" id="other" name="Patient.sex" value="O" asp-for="Patient.sex" /> Other
            </div>
            <span asp-validation-for="Patient.sex" class="text-danger small"></span>

            <br />
            <div class="form-group">
@*                 <span class="text-danger">*</span> *@
                <label for="MaritalStatus">Marital Status / ವೈವಾಹಿಕ ಸ್ಥಿತಿ:</label><br />
                <input type="radio" id="Married" name="Patient.MaritalStatus" value="2" asp-for="Patient.MaritalStatus" /> Married
                <input type="radio" id="Unmarried" name="Patient.MaritalStatus" value="3" asp-for="Patient.MaritalStatus" /> Unmarried
                <input type="radio" id="Widowed" name="Patient.MaritalStatus" value="4" asp-for="Patient.MaritalStatus" /> Widowed
                <input type="radio" id="Divorced" name="Patient.MaritalStatus" value="1" asp-for="Patient.MaritalStatus" /> Divorced
            </div>
           @*  <span asp-validation-for="Patient.MaritalStatus" class="text-danger small"></span> *@

           @*  <br /> *@
           @if (Model.Departments != null)
                    {
            <div class="form-group" style="display:none">
                <span class="text-danger">*</span>
                <label for="department">Department / ಇಲಾಖೆ: </label>
                <select id="department" class="form-control" asp-for="Patient.Department">
                    <option value="">Select Department</option>

                    
                        @foreach (var department in Model.Departments)
                        {
                            <option value="@department.Code">@department.Name</option>
                        }
                </select>
               @*  <span asp-validation-for="Patient.Department" class="text-danger small"></span> *@
            </div>
            

            @* <br />*@

            <div class="form-group" style="display:none">
                <span class="text-danger">*</span>
                <label for="departmentUnit">Unit / ವೈದ್ಯರ ಘಟಕ: </label>
                <select id="departmentUnit" class="form-control" asp-for="Patient.DepartmentUnit">
                    <option value=0>Select Department Unit</option>

                </select>
              @*   <span asp-validation-for="Patient.DepartmentUnit" class="text-danger small"></span> *@
            </div>
            }

           @*  <br /> *@
            @if (Model.PatientSources != null)
            {
                <div class="form-group" style="display:none">
                    <span class="text-danger">*</span>
                    <label for="patientsource">Patient Source ರೋಗಿಯ ಮೂಲ:</label>
                    <select id="patientsource" class="form-control" asp-for="Patient.PatientSourceCode">
                        <option value="">Select Source</option>
                    
                                @foreach (var patientsource in Model.PatientSources)
                                {
                                   if (patientsource.add_info_1!="1")
                                    {
                                        <option value="@patientsource.Code">@patientsource.Name</option>

                                    }
                                }

                    
                    </select>
                   @*  <span asp-validation-for="Patient.PatientSourceCode" class="text-danger small"></span> *@
                </div>
           }

            <br />  

            <div class="form-group">
                <span class="text-danger">*</span>
                <label for="mobileNo">Mobile Number / ಮೊಬೈಲ್ ನಂಬರ್:</label>
                <input type="text" id="mobileNo" class="form-control" asp-for="Patient.MobileNumber" />
                <span asp-validation-for="Patient.MobileNumber" class="text-danger small"></span>
            </div>

            <br />

            <div class="form-group">
                <label for="TxtAddressLine1">Address Line 1 / ವಿಳಾಸ ಸಾಲು 1:</label>
                <input type="text" id="TxtAddressLine1" class="form-control" asp-for="Patient.PatientAddressLine1" placeholder="House No, Street"  />
                <span asp-validation-for="Patient.PatientAddressLine1" class="text-danger small"></span>
            </div>

            <br />

            <div class="form-group">
                <label for="TxtAddressLine2">Address Line 2 / ವಿಳಾಸ ಸಾಲು 2:</label>
                <input type="text" id="TxtAddressLine2" class="form-control" asp-for="Patient.PatientAddressLine2" placeholder="Area, Locality" />
                <span asp-validation-for="Patient.PatientAddressLine2" class="text-danger small"></span>
            </div>

            <br />

            <div class="form-group">
                <label for="TxtAddressLine3">Address Line 3 / ವಿಳಾಸ ಸಾಲು 3:</label>
                <input type="text" id="TxtAddressLine3" class="form-control" asp-for="Patient.PatientAddressLine3" placeholder="City, State, ZIP" />
                <span asp-validation-for="Patient.PatientAddressLine3" class="text-danger small"></span>
            </div>


            <br />
           
            <button type="submit" name="btnSubmit" value="btnSave" asp-page-handler="Save" accesskey="S" class="btn btn-success btn-lg">Register Patient</button>
            &nbsp; &nbsp;
            <button type="button" accesskey="C" class="btn btn-secondary btn-lg" id="clearForm">Clear</button>



            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#staticBackdrop" hidden >
                Download Data
            </button>


        </div>
    </div>



</form>
@if (Model.PatientSources != null)
{
    <form method="post" id="downloadForm">


        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">Download Patient Registration Data </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                        <div class="modal-body">
                            <label for="patientsource2">Patient Source ರೋಗಿಯ ಮೂಲ:</label>
                            <select id="patientsource2" class="form-control" asp-for="Patient.PatientSourceCode">
                                <option value="">Select Source</option>

                                @foreach (var patientsource in Model.PatientSources)
                                {
                                    <option value="@patientsource.Code">@patientsource.Name</option>
                                }


                            </select>

                        </div>

                    <div class="modal-footer">

                        @*                     <button class="btn btn-primary" value="btnDownload" asp-page-handler="DownloadData">
                    Download
                    </button>
                    *@

                        <button class="btn btn-primary" value="btnDownload" id="btnDownload" onclick="validateDownload()" asp-page-handler="DownloadData">
                            Download
                        </button>


                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                    </div>
                </div>
            </div>
        </div>


    </form>
}



